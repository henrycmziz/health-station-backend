kind: pipeline
type: docker
name: hs-backend-ci

steps:
  # æ‰“åŒ…
  - name: mvn-package
    pull: if-not-exists
    image: maven:3.6.1-jdk-8-alpine
    volumes: # å°†å®¹å™¨å†…ç›®å½•æŒ‚è½½åˆ°å®¿ä¸»æœºï¼Œä»“åº“éœ€è¦å¼€å¯Trustedè®¾ç½®
      # å°†mavenä¸‹è½½ä¾èµ–çš„ç›®å½•æŒ‚è½½å‡ºæ¥ï¼Œé˜²æ­¢é‡å¤ä¸‹è½½
      - name: maven-cache
        path: /root/.m2
      # å°†åº”ç”¨æ‰“åŒ…å¥½çš„Jarå’Œæ‰§è¡Œè„šæœ¬æŒ‚è½½å‡ºæ¥
      - name: backend-temp
        path: /app
    commands:
      - mvn clean package -Dmaven.test.skip=true
      - cp backend-admin/target/backend-admin.jar /app/backend-admin.jar
      - cp .env /app/.env
      - cp Dockerfile /app/Dockerfile
      - cp docker-compose.yml /app/docker-compose.yml
      - cp deploy.sh /app/deploy.sh

  # æ„å»ºé•œåƒå¹¶éƒ¨ç½²è¿è¡Œ
  - name: docker-deploy
    image: appleboy/drone-ssh
    settings:
      host:
        from_secret: ssh_host
      username: root
      password:
        from_secret: ssh_password
      port: 22
      command_timeout: 10m # è¿œç¨‹æ‰§è¡Œå‘½ä»¤è¶…æ—¶æ—¶é—´
      script_stop: false # è®¾ç½®ä¸ºfalseï¼Œé‡åˆ°ç¬¬ä¸€æ¬¡é”™è¯¯ä¼šç»§ç»­è¿è¡Œåé¢çš„å‘½ä»¤
      script:
        - cd /app/health-station/backend # è¿›å…¥å®¿ä¸»æœºæ„å»ºç›®å½•,å¯æ ¹æ®è‡ªå·±é€‰æ‹©ç›®å½•
        - chmod +x deploy.sh # æ›´æ”¹ä¸ºå¯æ‰§è¡Œè„šæœ¬
        - ./deploy.sh # è¿è¡Œè„šæœ¬æ‰“åŒ…åº”ç”¨é•œåƒå¹¶è¿è¡Œ

  # é’‰é’‰é€šçŸ¥
  - name: dingtalk-notice
    image: lddsb/drone-dingtalk-message
    settings:
      token:
        from_secret: dingtalk_token
      secret:
        from_secret: dingtalk_secret
      type: markdown
      tips_title: hs-backend-ci-info
      success_color: 09c270
      failure_color: ff3c3c
      tpl_build_status_success: "=== âˆš  SUCCESS ==="
      tpl_build_status_failure: "=== Ã—  FAILURE ==="
      debug: true
      tpl: |
        ## <font color=[TPL_STATUS_COLOR]> [TPL_BUILD_STATUS] </font>
        
        ### ğŸ“ [TPL_REPO_SHORT_NAME]
        
        > ğŸ‘¨ [TPL_AUTHOR_NAME] | ğŸ”€ [TPL_COMMIT_BRANCH] | â±ï¸ `[TPL_BUILD_CONSUMING]s`
        ___
        
        ğŸ’¬ **Commit Message**
        
        > [TPL_COMMIT_MSG]
        ___
        
        ğŸ‘‡ **Detail**
        
        [ğŸ”— Committed Code Detail Page]([TPL_COMMIT_LINK])
        
        [ğŸ”— The Build Detail Page [TPL_STATUS_EMOTICON]]([TPL_BUILD_LINK])
        ___
    when:
      status: [ success,failure ]


volumes: # å®šä¹‰æµæ°´çº¿æŒ‚è½½ç›®å½•ï¼Œç”¨äºå…±äº«æ•°æ®
  - name: backend-temp
    host:
      path: /app/health-station/backend
  - name: maven-cache
    host:
      path: /app/health-station/backend/.m2

# droneæ‰§è¡Œè§¦å‘åˆ†æ”¯
trigger:
  branch:
    - master
  event:
    - push
